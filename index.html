<!DOCTYPE html>
<html>
	<head>
		<!-- https://dotnetu.local/ldap/im.html -->
		<!-- https://dotnetu.local/ldap/im_devel.html -->
		<!-- https://iam.local.santannapisa.it -->

		<!-- redirect -->
		<!-- <meta http-equiv="refresh" content="0; URL='im_devel.html'" /> -->

		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="description" content="Identity Management">
		<meta name="keywords" content="Identity Management">
		
		<meta name="author" content="Alberto Bongiorni">

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
		
		<!-- https://bootstrap-autocomplete.readthedocs.io/en/latest/ -->
		<!-- <script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.3/dist/latest/bootstrap-autocomplete.min.js"></script> -->
		<script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>
		
		<!-- https://fontawesome.com/search?m=free -->
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">		

		<!-- https://momentjs.com/ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.21.0/moment.min.js" type="text/javascript"></script>

		<!-- https://developer.snapappointments.com/bootstrap-select/ -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-*.min.js"></script>		 -->

		<!--	https://www.jqueryscript.net/time-clock/Date-Time-Picker-Bootstrap-4.html -->
		<link rel="stylesheet" href="bootstrap-datetimepicker.min.css">
		<script src="bootstrap-datetimepicker.min.js"></script>
		
		<!-- https://datatables.net/ -->
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css">
		
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.21/b-1.6.2/b-colvis-1.6.2/b-html5-1.6.2/b-print-1.6.2/r-2.2.4/datatables.min.css"/>
		 
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
		<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.21/b-1.6.2/b-colvis-1.6.2/b-html5-1.6.2/b-print-1.6.2/r-2.2.4/datatables.min.js"></script>

		<!-- https://www.bootstraptoggle.com/ -->
		<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
		<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

		<!-- gestione immagini https://github.com/Foliotek/Croppie -->
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.4/croppie.min.css">
		<script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.4/croppie.min.js"></script>

		<script type="text/javascript" charset="utf8" src="dateformat.js"></script>

		<!-- <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script> -->
		<!-- <script src="tinymce.min.js"></script> -->
		<!-- <link rel="stylesheet" type="text/css" href="tinymce.min.css"> -->

		<!-- editor https://ace.c9.io/ -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.16.0/ace.js" type="text/javascript" charset="utf-8"></script>
		<!-- <script src="https://pagecdn.io/lib/ace/1.4.13/ace.js" type="text/javascript" charset="utf-8"></script> -->
		<!-- <script src="https://pagecdn.io/lib/ace/1.4.12/ace.js" type="text/javascript" charset="utf-8"></script> -->

		<script src="https://printjs-4de6.kxcdn.com/print.min.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">

    <title>Identity Management</title>

<script type="text/javascript">
var myDevel=0;
var myData='';
var myPhp='iam.php';
// var myPhp = location.href.split("/").slice(-1)[0].replace(".html", ".php");
var editor;
var eFileName='';
var eFontSize=18;
var tempo='';
var curobj='';
var aco='';
/*
var gdOggi = new Date();
var gDay = gdOggi.getDate();
var gMonth = gdOggi.getMonth() + 1; //Months are zero based
var gYear = gdOggi.getFullYear();
var gFM = new Date(gYear, gMonth - 1, 1);			// first
gsFM = ((gFM.getDate() < 10)?'0':'')+gFM.getDate()+'/'+(((gFM.getMonth() + 1) < 10)?'0':'')+(gFM.getMonth() + 1)+'/'+gFM.getFullYear();
if (gMonth < 12) {var gLM = new Date(gYear, gMonth, 0); } else {var gLM = new Date(gYear + 1, 1, 0); }	// last
gsLM = ((gLM.getDate() < 10)?'0':'')+gLM.getDate()+'/'+(((gLM.getMonth() + 1) < 10)?'0':'')+(gLM.getMonth() + 1)+'/'+gLM.getFullYear();
if (gMonth < 12) {var gFNM = new Date(gYear, gMonth, 1); } else {var gFNM = new Date(gYear + 1, 0, 1); }			// first succ
gsFNM = ((gFNM.getDate() < 10)?'0':'')+gFNM.getDate()+'/'+(((gFNM.getMonth() + 1) < 10)?'0':'')+(gFNM.getMonth() + 1)+'/'+gFNM.getFullYear();
if (gMonth < 12) {var gLNM = new Date(gYear, gMonth + 1, 0); } else {var gLNM = new Date(gYear + 1, 1, 0); }	// last succ
gsLNM = ((gLNM.getDate() < 10)?'0':'')+gLNM.getDate()+'/'+(((gLNM.getMonth() + 1) < 10)?'0':'')+(gLNM.getMonth() + 1)+'/'+gLNM.getFullYear();
if (gMonth > 1) {var gFPM = new Date(gYear, gMonth - 2, 1); } else {var gFPM = new Date(gYear - 1, 11, 1); }	// first prev
gsFPM = ((gFPM.getDate() < 10)?'0':'')+gFPM.getDate()+'/'+(((gFPM.getMonth() + 1) < 10)?'0':'')+(gFPM.getMonth() + 1)+'/'+gFPM.getFullYear();
if (gMonth > 1) {var gLPM = new Date(gYear, gMonth - 1, 0); } else {var gLPM = new Date(gYear, 0, 0); }				// last prev
gsLPM = ((gLPM.getDate() < 10)?'0':'')+gLPM.getDate()+'/'+(((gLPM.getMonth() + 1) < 10)?'0':'')+(gLPM.getMonth() + 1)+'/'+gLPM.getFullYear();

// alert(gsFNM+"\n"+gsLNM+"\n"+gsFM+"\n"+gsLM+"\n"+gsFPM+"\n"+gsLPM);
*/	
$(function() {
	myData='';
	$.ajax({
		type:'POST',url:myPhp,dataType:'text',async:false,data:{},
		beforeSend: function(data){mm({tit:'ATTESA'});},
	}).done(function(data) { 
		if($('#myModal').length > 0){$("#myModal").modal('hide');}
		if($('#myModalAttesa').length > 0){$("#myModalAttesa").modal('hide');}
//		if($("#myModal").length){$("#myModal").remove();}
//		if($("#myModalAttesa").length){$("#myModalAttesa").remove();}
//		if($(".modal-backdrop").length){$(".modal-backdrop").remove();}
		try {
			myData = atob(data);	
		} catch (e) {
			mm({tit:'<h2>Errore</h2>',stl:'bg-danger text-center text-white'});
		}
		$("#contenuto").html(myData);
	}).fail(function( jqXHR, textStatus ) {
		mm({tit:'<h2>Errore</h2>',msg:textStatus,stl:'bg-danger text-center text-white'});
		setTimeout(function() {location.reload();}, 10000);
	});
	listener();
	setInterval(ka, 20*60*1000);	// 20 minuti	
});
jQuery.fn.serializeObject = function(){
	// https://www.helicaltech.com/get-form-data-as-an-object-using-jquery/
	// usage: $('#myForm').serializeObject();
	var results = {},
	arr = this.serializeArray();
	for (var i = 0, len = arr.length; i < len; i++) {
		obj = arr[i];
		//Check if results have a property with given name
		if (results.hasOwnProperty(obj.name)) {
			//Check if given object is an array
			if (!results[obj.name].push) {
				results[obj.name] = [results[obj.name]];
			}
			results[obj.name].push(obj.value || '');
		} else {
			results[obj.name] = obj.value || '';
		}
	}
	return results;
}		
jQuery.fn.getType = function(){return this[0].tagName == "INPUT" ? this[0].type.toLowerCase() : this[0].tagName.toLowerCase();} // // Will return radio, text, checkbox, select, textarea, etc (also DIV, SPAN, all element types)
function ka(){
	myData='';
	$.ajax({
		type:'POST',url:myPhp,dataType:'text',async:true,data:{func:'ga'},
	}).done(function(data) { 
		try {
			myData = atob(data);	
			if (myData==''){
				mm({tit:'<h2>Errore</h2>',stl:'bg-danger text-center text-white'});
				setTimeout(function() {
					location.reload(true);
				}, 5000);
			}
		} catch (e) {
			mm({tit:'<h2>Errore</h2>',msg:'Sessione scaduta rileggi la pagina',stl:'bg-danger text-center text-white'});
		}
	}).fail(function( jqXHR, textStatus ) {
		mm({tit:'<h2>Errore</h2>',msg:textStatus,stl:'bg-danger text-center text-white'});
		setTimeout(function() {
			location.reload(true);
		}, 5000);
	});
}
function listener(){
	var navMain = $(".navbar-collapse"); 
	navMain.on("click", "a:not([data-toggle])", null, function () {navMain.collapse('hide');});
	$(".nav-link").click(function(e) {
		$('#navbar-text').html($(this).html());
		$(".contenuti").addClass("d-none");
		var divcont=$(this).attr("divcont");
		$("#"+divcont).removeClass("d-none");
		$(".nav-link").removeClass("active");
		$(this).addClass("active");
	});	

	try {
		if ($("#editor").length){
			editor = ace.edit("editor");
			editor.setTheme("ace/theme/monokai");
			editor.session.setMode({path: "ace/mode/json",v: Date.now()});
			editor.session.setUseSoftTabs(true);
			editor.session.setUseWrapMode(true);	
			editor.setFontSize(eFontSize);
		}
	}
	catch(err) {
		if ($("#editor").length){
			// document.getElementById("demo").innerHTML = err.message;
			$("#editor").text(err.message);
		}
	}

	$('#eFontSize').html(eFontSize);
	$('[dto]').datetimepicker({
		showTodayButton: true
		,format: 'DD/MM/YYYY'				// data
		// ,format: 'DD/MM/YYYY HH:mm'	// data e ora-minuti
	});
	$('[dtom]').datetimepicker({
		showTodayButton: true
		// ,format: 'DD/MM/YYYY'				// data
		,format: 'DD/MM/YYYY HH:mm'	// data e ora-minuti
	});
	
	if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
		$('[sep]').selectpicker('mobile');
	} else {
		$('[sep]').selectpicker();
	}
	
	$("[ckb]").bootstrapToggle();

	// $('[dom]').on('click', function (event) {
	// 	var dom=$(this).attr("dom");
	// 	exportTableToCSV.apply(this, [$('#'+dom+'>table'), dom+'.csv']);    
	// });	

	$('[bta]').off('keypress').on('keypress', function(e){		
	//	e.preventDefault(); 							// ferma l'evento
	//	$('[bta]').keypress(function(e){
		if(e.keyCode == 13){
			var bta=$(this).attr("bta"); 			// button
			$("#"+bta)[0].click();
			return false;                 
		}
	});		

	$( ".colnext" ).off('click').on('click', function(e){
		var t = $(this).next();
		t.toggle();
	});			
	
	$('[act]').off('click').on('click', function(e){		
		e.preventDefault(); 							// ferma l'evento
		var act=$(this).attr('act'); 			// azione
		var id=$(this).attr('id');				// id
		var dom=$(this).attr('dom');			// dom
		myData='';
		switch(act) {
			case '+':
				if (eFontSize < 36 ) {
					eFontSize = eFontSize + 2;
					$('#eFontSize').html(eFontSize);
					editor.setFontSize(eFontSize);
				}
				break;
			case '-':
				if (eFontSize > 6 ) {
					eFontSize = eFontSize - 2;
					$('#eFontSize').html(eFontSize);
					editor.setFontSize(eFontSize);
				}
				break;
			case 's_acl':
				myData='';
				var aa=vin($(this));
				aa['cta']=editor.getValue();
				$.ajax({
					type:'POST',url:myPhp,dataType:'text',async:false
					,data:aa
				}).done(function(data) { 
//					if($("#myModal").length){$("#myModal").modal('hide');}
					try {
						myData=atob(data);
					} catch (e) {
						myData = '';
						mm({tit:'<h2>Errore</h2>',stl:'bg-danger text-center text-white'});
					}
				}).fail(function( jqXHR, textStatus ) {
					myData = '';
					mm({tit:'<h2>Errore</h2>',msg:textStatus,stl:'bg-danger text-center text-white'});
				});
				vout($(this));
				break;
			case 'e_acl':
				myData='';
				var aa=vin($(this));
				eFileName = aa['fn'];
				$.ajax({
					type:'POST',url:myPhp,dataType:'text',async:false,data:aa
				}).done(function(data) { 
//					if($("#myModal").length){$("#myModal").modal('hide');}
					try {
						myData=atob(data);
					} catch (e) {
						myData = '';
						mm({tit:'<h2>Errore</h2>',stl:'bg-danger text-center text-white'});
					}
				}).fail(function( jqXHR, textStatus ) {
					myData = '';
					mm({tit:'<h2>Errore</h2>',msg:textStatus,stl:'bg-danger text-center text-white'});
				});
				if (myData != ''){
					$('#eFileName').html(eFileName);
					var fnp = eFileName.split('.');
					var fne = fnp[fnp.length -1];
					$('#eFontSize').html(eFontSize);

					editor.getSession().setMode({path: "ace/mode/".fne, v: Date.now()});
					editor.getSession().setValue(myData, -1);
					// editor.resize();

				}
				break;																		
			case 'toggleDTX':
				var tabledom=$(this).attr("tabledom");
				if (!$.fn.DataTable.isDataTable('#'+tabledom)) {
					dtt(tabledom);
				} else {
					$('#'+tabledom).DataTable().destroy();
					$("[added~='"+tabledom+"']").remove();
				}
				break;
			case 'up':
				// alert('up'); // @@@@
				curobj=$(this);
				var un=$(this).attr("un");
				var fd = new FormData(); 
				var files = $('#fileToUpload')[0].files[0]; 
				fd.append(un, files); 
				var aa = vin(curobj);
				Object.keys(aa).forEach(function(key) {
					fd.append(key, aa[key]); 
				});
				$.ajax({ 
					type:'POST',url:myPhp,async:false,data:fd,contentType:false,processData:false,
//					beforeSend: function(data) {mm({tit:'ATTESA'});},
				}).done(function(data) { 
//					if($("#myModal").length){$("#myModal").modal('hide');}
					try {
						myData=atob(data);
						vout(curobj);
					} catch (e) {
						m=e.message;
						if (isNaN(data)){} else {m+='<br />'+data;}
						mm({tit:'<h2>Errore</h2>',msg:m,stl:'bg-danger text-center text-white'});
					}
				}).fail(function( jqXHR, textStatus ) {
					m=textStatus;
					if (isNaN(data)){} else {m+='<br />'+data;}
					mm({tit:'<h2>Errore</h2>',msg:m,stl:'bg-danger text-center text-white'});
				});
				break;
			default:
				curobj=$(this);
				$.ajax({
					type			:	'POST'
					,url			:	myPhp
					,dataType		:	'text'
					,async			:	true
					,cache			:	false
					,data			:	vin(curobj) // aa
					,beforeSend	: function( data ) {mm({tit:'ATTESA'});}
				}).done(function(data) { 
					if($('#myModal').length > 0){$("#myModal").modal('hide');}
					if($('#myModalAttesa').length > 0){$("#myModalAttesa").modal('hide');}
					try {
						myData = atob(data);	
						vout(curobj);
					} catch (e) {
						m=e.message;
						if (isNaN(data)){} else {m+='<br />'+data;}
						mm({tit:'<h2>Errore</h2>',msg:m,stl:'bg-danger text-center text-white'});
					}
				}).fail(function( jqXHR, textStatus ) {
					m=textStatus;
					if (isNaN(data)){} else {m+='<br />'+data;}
					mm({tit:'<h2>Errore</h2>',msg:m,stl:'bg-danger text-center text-white'});
				});
		  	// break;
		}			
		listener();
		return false; 			// prevent bubbling
	});
}
function vin(o){
	var act=o.attr('act'); 			// azione
	var aa = {}; // array attributi
	aa['func']=act;
	aa['obj_val']=o.val();
	$.each(o[0].attributes, function(i, attrib){
		var name = attrib.name;
		var value = attrib.value;
		aa[name]=value;
	});
	var ff = {}; // array contenuto form
	if (typeof aa['tab'] !== 'undefined') {
		if($('#f_'+aa['tab']).length > 0) {
			var ff = $('#f_'+aa['tab']).serializeObject();
			// for (var index in ff) {ff[index] = btoa(ff[index]);}
		} else if($('#'+aa['tab']).length > 0) {
			var ff = $('#'+aa['tab']).serializeObject();
		}
	}
	if (typeof aa['getf'] !== 'undefined') {
		var ai=aa['getf'].split(',');
		for (i=0; i < ai.length; i++){
			if($('#'+ai[i]).length > 0) {
				aa[ai[i]] = $('#'+ai[i]).val();
			}
			if($("[name='"+ai[i]+"']:checked").length > 0) {
				aa[ai[i]] = $("[name='"+ai[i]+"']:checked").val();
			}
		}
	}
	if (typeof aa['gett'] !== 'undefined') {
		var ai=aa['gett'].split(',');
		for (i=0; i < ai.length; i++){
			if($('#'+ai[i]).length > 0) {
				aa[ai[i]] = $('#'+ai[i]).text();
			}
		}
	}
	// metto in ff quello che c'è in aa
	Object.keys(aa).forEach(function(key) {
		// if (typeof aa[key] === 'undefined') {	// solo se non già presente nella form
			ff[key] = aa[key];
		// }
	});
	return ff;
}
function vout(o){
	var act=o.attr('act'); 	// azione
	var dom=o.attr('dom');	// destinazione
	var fao=o.attr('fao');	// fadeOut
	if (isNaN(fao)){
		var delay=0;
	} else {
		if (typeof fao == "string"){
			var delay = Number(fao);
		} else {
			var delay = fao;
		}
	}
	if (myData != ''){
		var r = '';
		try {r = JSON.parse(myData);} catch (e) {r = '';}
		if (typeof r == 'object'){
			if ('nova' in r && 'vava' in r){window[r['nova']]=r['vava'];}
			if ('dom' in r){dom=r['dom'];}
			if ('domm' in r){
				var rr = r['domm'];
				if (typeof rr == 'object'){
					for (i=0; i < rr.length; i++){
						// var oo=rr[i];
						if($('#'+rr[i]['domf']).length > 0) {
							$('#'+rr[i]['domf']).html(rr[i]['domc']); // str.replace(/\\/g, '')
						}
					}
				}
			}
			if ('domi' in r){
				var rr = r['domi'];
				if (typeof rr == 'object'){
					for (i=0; i < rr.length; i++){
						// var oo=rr[i];
						if($('#'+rr[i]['domf']).length > 0) {
							if ($('#'+rr[i]['domf']).getType()=='select'){
								$('#'+rr[i]['domf']).selectpicker('val', rr[i]['domc']);
							} else {
								$('#'+rr[i]['domf']).val(rr[i]['domc']);
							}
						}
					}
				}
			}
			if ('domfunc' in r){
				var rr = r['domfunc'];
				if (typeof rr == 'object'){
					for (i=0; i < rr.length; i++){
						if($('#'+rr[i]['domf']).length > 0) {
							$("#"+rr[i]['domf']).append(rr[i]['domc']);
							// $('#'+rr[i]['domf']).val(rr[i]['domc']);
						}
					}
				}
			}
		}
		$('[sep]').selectpicker('render');
		if (dom == 'mm' && typeof r == 'object'){mm(r);}
		if (dom == 'ff' && typeof r == 'function'){call(r);}
		if (dom == 'pp' && typeof myData == 'string'){
/*
			if($('#div_print').length > 0) {
				$('#div_print').html(myData);
			} else {
				$( "body" ).append('<div id="div_print">'+myData+'</div>');
			}
			printJS('div_print', 'html');
*/			
//			$("#div_print").printThis();
//			$("#div_print").print();
// 			$("#div_print").remove();
			
			var win = window.open("", "new", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+(screen.width-500)+",height="+(screen.height-300)+",top=130,left=350");
			// win.document.write();
			win.document.body.innerHTML = myData;
			win.print();
			
		}
		if ((dom == 'dd') && typeof myData == 'string'){
			$( "body" ).append('<a id="b_export" href="'+myData+'" target="_blank" style="display: none">CSV or PDF</a>');
			$("#b_export")[0].click();
			$("#b_export").remove();
		}
		if (dom == "_blank" && typeof myData == "string"){
//			var win = window.open("", "new", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=780,height=200,top="+(screen.height-400)+",left="+(screen.width-840));
			// var win = window.open("", "new", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=780,height=620,top=0,left=0");
			var win = window.open("", "new", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+(screen.width-500)+",height="+(screen.height-300)+",top=130,left=350");
			// win.document.write();
			win.document.body.innerHTML = myData;
//			var pp=o.attr('pp');	
//			if (typeof pp !== 'undefined') {
//				win.onload = function(){
//						win.print();
//				}
//			}
		}
//		if (r == '' && dom=='' && act=='reloadtab'){dom=tab;}
//		if (r == '' && dom!='' && typeof myData=="string"){
		if (dom!='' && typeof myData=="string"){
			if($('#'+dom).length > 0) {
				if (delay > 0 ){
					$('#'+dom).html('<span id="temporaneo">'+myData+'</span>');
					$('#temporaneo').fadeOut(delay);
				} else {
					$('#'+dom).html(myData);
				}
			}
		}
	} else {
		mm({tit:'<h2>Nessun dato trovato</h2>',stl:'bg-info text-center text-white'});
	}	
	if (act=='cn_foto'){foto();}

	$('[data-toggle="tooltip"]').tooltip();	
	$('[data-toggle="popover"]').popover(); 		

	listener();
}
function dtt(tabledom){
	if (!$("#"+tabledom).length){return;}
	var colcir=[]; 	// colonne con intestazione di ricerca
	var colr=[];	// colonne allineate a destra
	// if (tabledom=='tb-camere'){
	//	 var colr=[1,2,3,];	
	// }
	$('#'+tabledom+' thead th').each(function() {
		var title = $('#'+tabledom+' thead th').eq($(this).index()).text();
		var nc=$(this).index();
		if (colcir.includes(nc) || colcir.length == 0) {
			$(this).html(title+'<br added="'+tabledom+'" /><input title="usa il pipe per suddividere i termini di ricerca" added="'+tabledom+'" placeholder="contiene" class="form-control yin" type="text" /><input title="usa il pipe per suddividere i termini di ricerca" added="'+tabledom+'" placeholder="non contiene" class="form-control nin" type="text" />');
		}
	});	
	$('#'+tabledom).each(function() {
		var t=$(this).DataTable({
			lengthMenu: 	[[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tutti"]]
			,responsive: 	true
			,retrieve: 		true
			,order: [[ 0, "desc" ]]
			,columnDefs: [
				{className:"text-right", targets:colr}
				// ,{type:"numString", targets:colr}
			]
			,buttons: ['colvis','copy','excel','print','pdf']
			// ,buttons: ['colvis','copy','print','pdf']
			,dom: '<B>lfrtip'
			,drawCallback: function( settings ) {listener();}
		});	
		// t.order([0, 'desc']).draw();						
		t.columns().eq(0).each(function(colIdx) {
			$('.yin, .nin', t.column(colIdx).header()).on('keyup change', function() {
				var vyin=$(this).parent().find('.yin').not().val();	// da includere
				var vnin=$(this).parent().find('.nin').val();				// da escludere
				var s='';
				if (vyin!='' || vnin!=''){
					var s='^'+((vnin!='')?'(?!.*('+vnin+')).*':'')+((vyin!='')?'.*('+vyin+').*':'')+'$';
				}
				if (s==''){
					$(this).css('background', '#fff'); // se vuoto bg bianco
				} else {
					$(this).css('background', '#ff0'); // se non vuoto bg giallo
				}
//					$("#debug").html(s);
				t.column(colIdx).search(s, true, true).draw();
			});
			$('input', t.column(colIdx).header()).on('click', function(e) {
				e.stopPropagation();
			});
		});	
	});	
}
function mm(p){												//
	// https://www.w3schools.com/bootstrap4/bootstrap_ref_js_modal.asp
	var stl=''; msg=''; btn=''; tit='';
	if (typeof p == 'object'){
		var tit = p['tit'] || ''; // titolo
		var msg	= p['msg'] || ''; // contenuto del messaggio
		var stl = p['stl'] || ''; // classe per header e footer (bg-success, bg-danger, text-white ...)
		var btn = p['btn'] || ''; // bottoni nel footer 
		var cbk = p['cbk'] || null; // callback (può essere una funzione)
		// oltre al contenuto del messaggio posso scrivere un contenuto domc nel domf
		var domf = p['domf'] || '';		// dom da modificare 
		var domc = p['domc'] || ''; 	// contenuto da sostituire in dom
		var domf1 = p['domf1'] || '';		// dom da modificare 
		var domc1 = p['domc1'] || ''; 	// contenuto da sostituire in dom
		var domf2 = p['domf2'] || '';		// dom da modificare 
		var domc2 = p['domc2'] || ''; 	// contenuto da sostituire in dom
		var domf3 = p['domf3'] || '';		// dom da modificare 
		var domc3 = p['domc3'] || ''; 	// contenuto da sostituire in dom
	}
	if (typeof p == 'string'){msg=p;}
	if($("#myModal").length){$("#myModal").remove();}
	if($("#myModalAttesa").length){$("#myModalAttesa").remove();}
	if($(".modal-backdrop").length){$(".modal-backdrop").remove();} 
	if (tit == 'ATTESA'){
		var sm='<div class="modal" id="myModalAttesa">';
			sm+='<div class="modal-dialog modal-dialog-centered" role="dialog">';
				sm+='<div class="modal-content">';
					sm+='<div class="modal-body" style="padding:40px 50px;">';
						sm+='<h1 id="pbstatus">Processing...</h1>';
						sm+='<div class="progress">';
							sm+='<div class="progress-bar progress-bar-striped progress-bar-animated" style="" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100">';
								sm+='<span id="complete-info"></span>';
							sm+='</div>';
						sm+='</div>';
					sm+='</div>';
				sm+='</div>';
			sm+='</div>';
		sm+='</div>';
		$('body').append(sm);
		// ziatt=$("#myModalAttesa").css("z-index");
/*
		tempo = setInterval(function(){
			$.ajax({
				method	:	'POST'
//				,url		:	myPhp
				,url		:	'gpc.php'	
				,async	:	true
				,cache	:	false
//				,data		:	{'func':'getpbp'}
			}).done(function(r) { 
				try {
					if(r >= 100) {
						if($('#pbstatus').length > 0){$('#pbstatus').html("Process Completed.");}
						clearInterval(tempo);
						tempo='';
						if($('#myModalAttesa').length > 0){$("#myModalAttesa").modal('hide');}
						// mm({tit:'FINE'});
					} else {
						if($('#myModalAttesa').length > 0){
							$('.progress-bar').attr("style","width:"+r+"%");
							$('.progress-bar #complete-info').html(r+"%");	
							$('.progress-bar').attr("aria-valuenow",r+"%");
						} else {
							$('body').append(sm);
							$("#myModalAttesa").modal();
							// ziatt=$("#myModalAttesa").css("z-index");
						}
					}
				} catch (e) {
					// handle errors here
					clearInterval(tempo);
					tempo='';
					$("#myModalAttesa").modal('hide');
					mm({tit:'ERRORE',msg:e});
				}
			}).fail(function( jqXHR, textStatus ) {
				mm({tit:'<h2>Errore</h2>',msg:textStatus,stl:'bg-danger text-center text-white'});
			});

//  			$.ajax({
//  				type: 'POST',
//  				url: myPhp,
//  				data: {'func':'getpbp'},
//  				success: function(r) {
//  					try {
//  						if(r >= 100) {
//  							$('#pbstatus').html("Process Completed.");
//  							clearInterval(tempo);
//  							tempo='';
//  							$("#myModalAttesa").modal('hide');
//  							// mm({tit:'FINE'});
//  						} else {
//  							if($('#myModalAttesa').length > 0){
//  								$('.progress-bar').attr("style","width:"+r+"%");
//  								$('.progress-bar #complete-info').html(r+"%");	
//  								$('.progress-bar').attr("aria-valuenow",r+"%");
//  							} else {
//  								$('body').append(sm);
//  								$("#myModalAttesa").modal();
//  								// ziatt=$("#myModalAttesa").css("z-index");
//  							}
//  						}
//  					} catch (e) {
//  						// handle errors here
//  						clearInterval(tempo);
//  							tempo='';
//  							$("#myModalAttesa").modal('hide');
//  							mm({tit:'ERRORE'});
//  					}
//  				}
//  			});	
		}, 1500);	
*/		
		$("#myModalAttesa").modal();
	} else {
		var w=' modal-sm';
		if (msg.length > 100) {w=' modal-lg';}
		if (msg.length > 200) {w=' modal-xl';}
//		if (msg.length > 400) {w=" modal";}
		var sm='<div class="modal" id="myModal"><div class="modal-dialog modal-dialog-centered'+w+'" role="dialog"><div class="modal-content"><div id="myMH" class="modal-header"></div><div id="myMB" class="modal-body" style="padding:40px 50px;"></div><div id="myMF" class="modal-footer"></div></div></div></div>';
		$('body').append(sm);
		if (stl==''){stl='bg-primary text-center text-white';}
		if (btn==''){btn='<button id="modal-ok" type="submit" class="btn btn-primary btn-block" data-dismiss="modal">ok</button>';}
		$('#myMH').html('<h4 class="modal-title">'+tit+'</h4>');
		$('#myMH').addClass(stl);
		$('#myMB').html('<div>'+msg+'</div>');
		$('#myMF').html(btn);
		if (domf != '' && domc != ''){$('#'+domf).html(domc);}
		if (domf1 != '' && domc1 != ''){$('#'+domf1).html(domc1);}
		if (domf2 != '' && domc2 != ''){$('#'+domf2).html(domc2);}
		if (domf3 != '' && domc3 != ''){$('#'+domf3).html(domc3);}
		listener();
		$("#myModal").modal({
			// onHide: cbk
			// ,backdrop: 'static'
			// ,keyboard: false		
		});
	}
	if (cbk && typeof cbk === 'function') {
		$("#myModal").on("hidden.bs.modal", function () {
			call(cbk);
		});
	}
	if($('#modal-ok').length) {$('#modal-ok').focus();}
	listener();
}
function foto() {
	var $uploadCrop;
	function readFile(input) {
		if (input.files && input.files[0]) {
			var reader = new FileReader();
			reader.onload = function (e) {
				$uploadCrop.croppie('bind', {
					url: e.target.result
				}).then(function(){
					console.log('jQuery bind complete');
				});
			}
			reader.readAsDataURL(input.files[0]);
		} else {
			mm("Sorry - you're browser doesn't support the FileReader API");
		}
	}
	$uploadCrop = $('#upload-box').croppie(
		{
			viewport: {width: 240, height: 360, type:'square'}
			,enableOrientation:	false
			,enableResize: 			false
			,enableZoom: 				true
			,enforceBoundary: 	true
			,mouseWheelZoom: 		true
			,showZoomer:				true
		}
	);
	$('#upload-foto').on('change', function() {readFile(this);});
	$('.upload-result').on('click', function(ev) {
		var tipo=$(this).attr('tipo');
		$uploadCrop.croppie('result', {
			type: 'base64',size: 'viewport',format: 'jpeg',quality: 1,circle: false
		}).then(function (resp) {
			myData='';
			var myUii=''; if ($('#uii').length) {myUii=$('#uii').val();}
			$.ajax({
				type:'POST',url:myPhp,dataType:'text',async:false,data:{func:'set_upload_foto',f64:resp,tipo:tipo,uii:myUii},
			}).done(function(data) { 
				try {
					myData = atob(data);
				} catch (e) {
					mm({tit:'<h2>Errore</h2>',stl:'bg-danger text-center text-white'});
				}
			}).fail(function( jqXHR, textStatus ) {
				mm({tit:'<h2>Errore</h2>',msg:textStatus,stl:'bg-danger text-center text-white'});
			});
			// messaggio di esito upload
			mm(myData);
			// reset privacy
//			myData='';
//			$.ajax({
//				type:'POST',url:myPhp,dataType:'text',async:false,data:{func:'get_privacy'},
//				success: function(data) {try {myData = atob(data);} catch (e) {}}
//			})
//			$('#out-rubrica').html(myData);	// ????
			listener();
		});
	});
}
</script>
	</head>
	<body>
		<div id="contenuto" class="container-fluid"></div>
	</body>
</html>
